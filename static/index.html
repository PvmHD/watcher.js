<html>
	<head>
		<title>watcher.js</title>

		<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.3.0/pure-min.css">
		<link rel="stylesheet" href="/asset/watcher.css">
		<meta author="boboman13" />
	</head>

	<body>
		<div class="pure-g">
			<div class="span-2"></div>
			<div class="span-6">
				<div class="pure-menu pure-menu-open pure-menu-horizontal">
					<ul>
						<li><a href="#" class="pure-button pure-button-active" title="Dedicated database node; San Jose">MySQL</a></li>
						<li><a href="#" class="pure-button" title="Dedicated frontend web node; San Jose">Website</a></li>
						<li><a href="#" class="pure-button" title="Static file delivery node; New York">CDN (New York)</a></li>
						<li><a href="#" class="pure-button" title="Static file delivery node; Great Britain">CDN (Great Britain)</a></li>
						<li><a href="#" class="pure-button" title="All node backup server; San Antonio">Backup</a></li>
						<li><a href="#" class="pure-button" title="Development, test node; San Antonio">Dev Node</a></li>
					</ul>
				</div>
			</div>
			<div class="span-2"></div>
		</div>

		<div class="alert">
			<p></p>
		</div>

		<div class="pure-g">
			<div class="span-1"></div>
			
			<div class="span-3">
				<div class="content">
					<div class="block-title">
						<h2>CPU Usage <small id="cpu-cores"></small></h2>
					</div>
					<div class="block">
						<div class="span-3">
							<h2 id="cpu-1">...</h2>
							<h3>1 min</h3>
						</div>
						<div class="span-3">
							<h2 id="cpu-2">...</h2>
							<h3>5 min</h3>
						</div>
						<div class="span-3">
							<h2 id="cpu-3">...</h2>
							<h3>15 min</h3>
						</div>
					</div>
				</div>

				<div class="content">
					<div class="block-title">
						<h2>Disk Usage</h2>
					</div>
					<div class="block">
						<table class="pure-table pure-table-horizontal block-table" id="disk-usage-table">
							<thead>
								<tr>
									<th>Filesystem</th>
									<th>Used</th>
									<th>Available</th>
								</tr>
							</thead>

							<tbody>
							</tbody>
						</table>
					</div>
				</div>
			</div>

			<div class="span-5">
				<div class="content">
					<div class="block-title">
						<h2>General &amp; CPU History</h2>
					</div>
					<div class="block block-padded">
						<div class="cpu-history">
							<canvas id="cpu-history" width="450" height="200"></canvas>
						</div>

						<p><b>Uptime:</b> <span id="node-uptime">..</span>, <b>Hostname:</b> <span id="node-hostname">..</span></p>
					</div>
				</div>

				<div class="content">
					<div class="block-title">
						<h2>RAM Usage</h2>
					</div>
					<div class="block block-padded">
						<div class="span-3">
							<h2 id="ram-total">...</h2>
							<h3>Total RAM</h3>
						</div>
						<div class="span-3">
							<h2 id="ram-free">...</h2>
							<h3>Free RAM</h3>
						</div>
						<div class="span-3">
							<h2 id="ram-used">...</h2>
							<h3>Used RAM</h3>
						</div>
					</div>
				</div>
			</div>

			<div class="span-1"></div>
		</div>

		<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
		<script src="//www.chartjs.org/assets/Chart.js"></script>
		<script>
		$(document).ready(function() {
			function initCPUHistoryChart() {
				var data = {
					labels: ["3 hr", "2.5 hr", "2 hr", "1.5 hr", "1 hr", ".5 hr"],
					datasets: [
					{
						fillColor: "#009B95",
						strokeColor: "#A2EF00",
						pointColor: "#FD0006",
						pointStrokeColor: "#fff",
						data: [1.28, 1.02, 0.95, 1.39, 1.21]
					}
					]
				};

				var ctx = $("#cpu-history").get(0).getContext("2d");
				var chart = new Chart(ctx).Line(data);
			}

			function getAmount(data) {
				data = parseInt(data);

				// go through
				if(data > 1024 * 10) {
					if(data / 1024 > 1024 * 10) {
						if(data / Math.pow(1024, 2) > 1024 * 10) {
							return Math.round(data / Math.pow(1024, 3)) + '<span class="data-calm">GB</span>';
						} else {
							return Math.round(data / Math.pow(1024, 2)) + '<span class="data-calm">MB</span>';
						}
					} else {
						return Math.round(data / 1024) + '<span class="data-calm">KB</span>';
					}
				} else {
					return data + ' <span class="data-calm">bytes</span>';
				}
			}

			function getAmountInTime(data) {
				data = parseInt(data);

				if(data > 60) {
					if(data / 60 > 60) {
						if(data / Math.pow(60, 2) > 60) {
							return Math.round(data / (Math.pow(60, 2) * 24)) + ' days';
						} else {
							return Math.round(data / Math.pow(60, 2)) + ' hours';
						}
					} else {
						return Math.round(data / 60) + ' minutes';
					}
				} else {
					return data + ' seconds';
				}
			}

			function addAlert(title, alert) {
				$(".alert")
					.html('<b>'+title+':</b> '+alert)
					.show();
			}

			function hideAlert() {
				$(".alert")
					.hide();
			}

			function refreshData() {
				console.log('watcher.js - refreshing data');

				// perform ajax
				$.ajax({
					url: '/get/server',
					type: 'GET',
					success: function(data) {
						hideAlert();
						// load average
						$("#cpu-1").text(data.load_average.one_min);
						$("#cpu-2").text(data.load_average.five_min);
						$("#cpu-3").text(data.load_average.fifteen_min);
						// num cpu
						$("#cpu-cores").text(data.num_cpu);
						// hostname
						$("#node-hostname").text(data.node_hostname);
						// ram usage
						var memtotal = parseInt(data.mem_usage.total), memfree = parseInt(data.mem_usage.free), memused = memtotal - memfree;
						var perfree = Math.round((memfree / memtotal) * 100), perused = Math.round((memused / memtotal) * 100);
						$("#ram-total").html(getAmount(memtotal));
						$("#ram-free").html(getAmount(memfree)+' ('+perfree+'%)');
						$("#ram-used").html(getAmount(memused)+' ('+perused+'%)');

						// disk usage
						$("#disk-usage-table > tbody").empty();
						for(var i in data.disk_usage) {
							var system = data.disk_usage[i].system;
							var used = data.disk_usage[i].used;
							var available  = data.disk_usage[i].available;
							var percent = data.disk_usage[i].percent;
							$("#disk-usage-table > tbody").append('<tr><td>'+system+'</td><td>'+getAmount(used)+'</td><td>'+getAmount(available)+' ('+percent+')</td></tr>');
						}

						// uptime
						$("#node-uptime").text(getAmountInTime(data.node_uptime));
					},
					error: function(xhr, status, error) {
						addAlert('Error refreshing', 'Could not refresh statistics. Will reattempt a connection.');
					}
				});
			}

			$(".block-title")
				.dblclick(function(event) {
					event.preventDefault();

					var obj = $(this).next('.block');

					if(obj.attr('data-shown') === 'true') {
						obj.animate({
							'height': '0px'
						}, 350);
						obj.attr('data-shown', 'false');
					} else {
						obj.animate({
							'height': 'auto'
						}, 350);
						obj.attr('data-shown', 'true');
					}
				});

			setInterval(refreshData, 5000);
			refreshData();
			initCPUHistoryChart();
		});
		</script>
	</body>
</html>